= page_header "Oceny - #{@subject.name}"
= info_box "Oceny", "Żeby dodać ocenę należy kliknąć na odpowiednie miejsce w tabeli.", image_tag("teacher_subjects_info_1.png", :style => "margin:0;", :class => "span5")
%table.table.table-striped.table-bordered.table-condensed
  %tr
    %th{:style => "width:15px;"} #
    %th{:style => "width:100px;"} Imię
    %th{:style => "width:100px;"} Nazwisko
    - @descriptions.each do |description|
      %th{:style => "width:30px;"}
        = link_to_delete_description(description)
    %th
      = render 'description_form', :description => @description, :subject => @subject
      = add_description_button
    %th{:style => "width:20px;"}
      %span.title_of_mark{:title => "Ocena semestralna"} OS
    %th{:style => "width:20px;"}= image_tag("average_ico.png", :class => "title_of_mark", :title => "Średnia z podanych ocen")
  - @students.each_with_index do |student, i|
    %tr
      %td= i+1
      %td= student.first_name
      %td= student.last_name
      - @descriptions.each_with_index do |description, j|
        %td.mark{:id => "#{student.id}_#{description.id}"}= @marks[i][j].mark if @marks[i][j]
      %td
      %td.semestral_mark{:id => "semestral_mark_#{student.id}"}= @semestral_marks[i].mark if @semestral_marks[i]
      %td.mark_average= sprintf("%1.2f", student.current_average_from_subject(@subject.id))
:javascript
  $(document).ready(function() {
    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader('X-CSRF-Token',$('meta[name="csrf-token"]').attr('content'));
      }
    });

    $(".description").popover();
    $("#add_description").popover();

    var parsed_id;

    $('.mark').live('click', function() {
      clone = $(this).clone();
      parsed_id = $(this).attr('id').split('_');
      old_mark = clone.text();
      clone.text('');
      clone.append('<input id="mark_active" name="mark[mark]" type="text" value="'+old_mark+'">');
      $(this).replaceWith(clone);
      $('#' + clone.attr('id')).children().focus();
    });

    $('#mark_active').live('blur', function() {
      mark = $(this).val();
      /* TODO */
      /*if (mark.match(/-/)) {

      } else if (mark.match(/+/)) {

      }*/
      data = 'mark[mark]=' + mark +
      '&mark[student_id]=' + parsed_id[0] +
      '&mark[description_id]=' + parsed_id[1] +
      '&subject_id=' + #{@subject.id}
      $.ajax({
        type: 'PUT',
        url: '/teacher/marks/update',
        data: data,
      });
      $(this).replaceWith(mark);
    });

    var parsed_id2;

    $('.semestral_mark').live('click', function() {
      clone = $(this).clone();
      parsed_id2 = $(this).attr('id').split('_');
      old_mark = clone.text();
      clone.text('');
      clone.append('<input id="semestral_mark_active" name="semestral_mark[mark]" type="text" value="'+old_mark+'">');
      $(this).replaceWith(clone);
      $('#' + clone.attr('id')).children().focus();
    });

    $('#semestral_mark_active').live('blur', function() {
      mark = $(this).val();
      /* TODO */
      /*if (mark.match(/-/)) {

      } else if (mark.match(/+/)) {

      }*/
      var data = 'semestral_mark[mark]=' + mark +
      '&semestral_mark[student_id]=' + parsed_id2[2] +
      '&semestral_mark[subject_id]=' + #{@subject.id}
      $.ajax({
        type: 'PUT',
        url: '/teacher/semestral_marks/update',
        data: data,
      });
      $(this).replaceWith(mark);
    });
  });
