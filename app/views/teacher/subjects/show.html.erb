<%= page_header "Oceny - #{@subject.name}" %>

<%= info_box "Oceny", "Żeby dodać ocenę należy kliknąć na odpowiednie miejsce w tabeli.", image_tag("teacher_subjects_info_1.png", :style => "margin:0;", :class => "span5") %>

<table class="table table-striped table-bordered table-condensed">

  <tr>
    <th style="width:15px;">#</th>
    <th style="width:100px;">Imię</th>
    <th style="width:100px;">Nazwisko</th>

    <% @descriptions.each do |description| %>
      <th style="width:30px;">
        <%= link_to_delete_description(description) %>
      </th>
    <% end %>

    <th>
      <%= render 'description_form', :description => @description, :subject => @subject %>
      <%= add_description_button %>
    </th>
    <th style="width:20px;"><span class="title_of_mark" title="Ocena semestralna">OS</span></th>
    <th style="width:20px;"><%= image_tag("average_ico.png", :class => "title_of_mark", :title => "Średnia z podanych ocen") %></th>
  </tr>
  <% @students.each_with_index do |student, i| %>
    <tr>
      <td><%= i+1 %></td>
      <td><%= student.first_name %></td>
      <td><%= student.last_name %></td>
      <% @descriptions.each_with_index do |description, j| %>
        <td id="<%= "#{student.id}_#{description.id}" %>" class="mark"><%= @marks[i][j].mark if @marks[i][j] %></td>
      <% end %>
      <td></td>
      <td id="semestral_mark_<%= student.id %>" class="semestral_mark border_b"><%= @semestral_marks[i].mark if @semestral_marks[i] %></td>
      <td class="mark_average"><%= sprintf("%1.2f", student.average_from_subject(@subject.id, @semester_id)) %></td>
    </tr>
  <% end %>
</table>

<script>
  $(document).ready(function() {
    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader('X-CSRF-Token',$('meta[name="csrf-token"]').attr('content'));
      }
    });

    $(".description").popover();
    $("#add_description").popover();

    var parsed_id;

    $('.mark').live('click', function() {
      clone = $(this).clone();
      parsed_id = $(this).attr('id').split('_');
      old_mark = clone.text();
      clone.text('');
      clone.append('<input id="mark_active" name="mark[mark]" type="text" value="'+old_mark+'">');
      $(this).replaceWith(clone);
      $('#' + clone.attr('id')).children().focus();
    });

    $('#mark_active').live('blur', function() {
      mark = $(this).val();
      /* TODO */
      /*if (mark.match(/-/)) {

      } else if (mark.match(/+/)) {

      }*/
      data = 'mark[mark]=' + mark +
      '&mark[student_id]=' + parsed_id[0] +
      '&mark[description_id]=' + parsed_id[1] +
      '&mark[subject_id]=' + <%= @subject.id %>
      $.ajax({
        type: 'PUT',
        url: '/teacher/marks/update',
        data: data,
      });
      $(this).replaceWith(mark);
    });

    var parsed_id2;

    $('.semestral_mark').live('click', function() {
      clone = $(this).clone();
      parsed_id2 = $(this).attr('id').split('_');
      old_mark = clone.text();
      clone.text('');
      clone.append('<input id="semestral_mark_active" name="semestral_mark[mark]" type="text" value="'+old_mark+'">');
      $(this).replaceWith(clone);
      $('#' + clone.attr('id')).children().focus();
    });

    $('#semestral_mark_active').live('blur', function() {
      mark = $(this).val();
      /* TODO */
      /*if (mark.match(/-/)) {

      } else if (mark.match(/+/)) {

      }*/
      var data = 'semestral_mark[mark]=' + mark +
      '&semestral_mark[student_id]=' + parsed_id2[2] +
      '&semestral_mark[subject_id]=' + <%= @subject.id %>
      $.ajax({
        type: 'PUT',
        url: '/teacher/semestral_marks/update',
        data: data,
      });
      $(this).replaceWith(mark);
    });
  });
</script>
